<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>dev-note-book | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ServiceFundamental Beginning with Android 5.0 (API level 21), the system throws an exception if you call bindService() with an implicit intent.  If your app targets API level 26 or higher, the system">
<meta property="og:type" content="article">
<meta property="og:title" content="dev-note-book">
<meta property="og:url" content="http://yoursite.com/2018/06/29/service/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ServiceFundamental Beginning with Android 5.0 (API level 21), the system throws an exception if you call bindService() with an implicit intent.  If your app targets API level 26 or higher, the system">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/AIDL%20Service.png">
<meta property="og:updated_time" content="2018-06-29T10:13:54.370Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dev-note-book">
<meta name="twitter:description" content="ServiceFundamental Beginning with Android 5.0 (API level 21), the system throws an exception if you call bindService() with an implicit intent.  If your app targets API level 26 or higher, the system">
<meta name="twitter:image" content="http://yoursite.com/AIDL%20Service.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-service" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/29/service/" class="article-date">
  <time datetime="2018-06-29T09:06:40.000Z" itemprop="datePublished">2018-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      dev-note-book
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><h3 id="Fundamental"><a href="#Fundamental" class="headerlink" title="Fundamental"></a>Fundamental</h3><ul>
<li><p>Beginning with Android 5.0 (API level 21), the system throws an exception if you call <code>bindService()</code> with an <strong>implicit intent</strong>.</p>
</li>
<li><p>If your app targets API level 26 or higher, the system imposes <a href="https://developer.android.com/about/versions/oreo/background.html" target="_blank" rel="noopener">restrictions on running background services</a> when the app itself is not in the <strong>foreground</strong>. In most cases like this, your app should use a <a href="https://developer.android.com/topic/performance/scheduling.html" target="_blank" rel="noopener">scheduled job</a> instead. See also <a href="https://developer.android.com/about/versions/oreo/background.html#services" target="_blank" rel="noopener">Background Service Limitations</a>.</p>
</li>
<li><p>Users can see what services are running on their device and can stop them. In order to avoid having your service stopped accidentally by users, you need to add the <a href="https://developer.android.com/guide/topics/manifest/service-element.html#desc" target="_blank" rel="noopener"><code>android:description</code></a> attribute to the <a href="https://developer.android.com/guide/topics/manifest/service-element.html" target="_blank" rel="noopener"><service></service></a> element in your app manifest. In the description, provide a short sentence explaining what the service does and what benefits it provides.</p>
</li>
<li><p><a href="https://developer.android.com/guide/components/activities/process-lifecycle.html" target="_blank" rel="noopener">process lifecycle</a></p>
<ul>
<li>foreground process</li>
<li>visible process</li>
<li>service process</li>
<li>cached process</li>
</ul>
</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mStartMode;       <span class="comment">// indicates how to behave if the service is killed</span></span><br><span class="line">    IBinder mBinder;      <span class="comment">// interface for clients that bind</span></span><br><span class="line">    <span class="keyword">boolean</span> mAllowRebind; <span class="comment">// indicates whether onRebind should be used</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// The service is being created</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// The service is starting, due to a call to startService()</span></span><br><span class="line">        <span class="keyword">return</span> mStartMode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// A client is binding to the service with bindService()</span></span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onUnbind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// All clients have unbound with unbindService()</span></span><br><span class="line">        <span class="keyword">return</span> mAllowRebind;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRebind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// A client is binding to the service with bindService(),</span></span><br><span class="line">        <span class="comment">// after onUnbind() has already been called</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// The service is no longer used and is being destroyed</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>The <code>startService()</code> method returns immediately, and the Android system calls the service’s <code>onStartCommand()</code> method. The binding is also asynchronous, and <code>bindService()</code> returns immediately without returning the <code>IBinder</code> to the client. 这意味着Service是异步创建的。</p>
</li>
<li><p>If <a href="https://developer.android.com/reference/android/content/Context.html#bindService(android.content.Intent, android.content.ServiceConnection, int" target="_blank" rel="noopener">bindService()</a>) returns false, your client does not have a valid connection to the service. However, your client should still call <code>unbindService()</code>; otherwise, your client will keep the service from shutting down when it is idle.</p>
</li>
<li><p>The Android system calls <a href="https://developer.android.com/reference/android/content/ServiceConnection.html#onServiceDisconnected(android.content.ComponentName" target="_blank" rel="noopener">onServiceDisconnected()</a>) when the connection to the service is <strong>unexpectedly</strong> lost, such as when the service has crashed or has been killed. This is <strong><em>not</em></strong> called when the client unbinds.</p>
</li>
<li><p>If your service is started and accepts binding, then when the system calls your <code>onUnbind()</code> method, you can optionally return <code>true</code> if you would like to receive a call to <code>onRebind()</code> the next time a client binds to the service. <code>onRebind()</code> returns void, but the client still receives the <code>IBinder</code> in its <code>onServiceConnected()</code> callback. </p>
</li>
<li><p>Unless the service is bound to a client, the system destroys it when the service is stopped by calling <code>stopSelf()</code> or <code>stopService</code>. When the last client unbinds from the service, the system destroys the service, unless the service was also started by <code>startService()</code>. That is, the system destroys an service only after no clients bound to it and explicitly stopped if has been started.</p>
</li>
</ul>
<h3 id="AIDL"><a href="#AIDL" class="headerlink" title="AIDL"></a>AIDL</h3><h4 id="AIDL-线程与阻塞"><a href="#AIDL-线程与阻塞" class="headerlink" title="AIDL 线程与阻塞"></a>AIDL 线程与阻塞</h4><ul>
<li><p>A service runs in the <strong>main thread</strong> of its hosting process; the service does <strong>not</strong> create its own thread and does <strong>not</strong> run in a separate process unless you specify otherwise.</p>
</li>
<li><p>Calls made from the <strong>local process</strong> are executed in the <strong>same thread</strong> that is making the call.</p>
</li>
<li><p>Calls from a remote process are dispatched from a <strong>thread pool</strong> the platform maintains inside of your own process. You must be prepared for incoming calls from unknown threads, with multiple calls happening at the same time. In other words, an implementation of an AIDL interface must be completely <strong>thread-safe</strong>.</p>
<blockquote>
<p>当客户端调用服务端提供的<code>IBinder</code>接口时，客户端会被<strong><em>阻塞</em></strong>直到方法返回。在服务进程，系统维护一个线程池，当服务端接口被调用的请求到达时，系统从线程池中调起一个线程来执行服务。</p>
</blockquote>
</li>
<li><p>The <code>oneway</code> keyword modifies the behavior of <strong>remote calls</strong>. When used, a remote call does not block; it simply sends the transaction data and immediately returns. The implementation of the interface eventually receives this as a regular call from the <code>Binder</code> thread pool as a normal remote call. If <code>oneway</code> is used with a <strong>local call</strong>, there is no impact and the call is still synchronous.</p>
<blockquote>
<p>已验证：<code>oneway</code>用于修饰接口，表示对该接口所有方法的调用是“单向”的，即无需等待返回数据，方法的返回类型只能是<code>void</code>，并且不含有<code>out</code>或者<code>inout</code>修饰的参数。调用该接口的线程不会被阻塞。</p>
<p>从根据AIDL文件生成的<code>Proxy</code>类中，可以看到在调用<code>Binder.transact(int code, Parcel data, Parcel reply, int flags)</code>方法时，传递了<code>android.os.IBinder.FLAG_ONEWAY</code>给flag参数，该值用于标示非阻塞调用<strong>远程</strong>接口。</p>
</blockquote>
</li>
</ul>
<h4 id="AIDL-接口定义"><a href="#AIDL-接口定义" class="headerlink" title="AIDL 接口定义"></a>AIDL 接口定义</h4><ul>
<li><p>AIDL 接口是用Java语法定义的。</p>
<p>By default, AIDL supports the following data types:</p>
<ul>
<li><p>All primitive types in the Java programming language (such as <code>int</code>, <code>long</code>, <code>char</code>, <code>boolean</code>, and so on)</p>
</li>
<li><p><code>String</code></p>
</li>
<li><p><code>CharSequence</code></p>
</li>
<li><p><code>List</code></p>
<p>All elements in the <code>List</code> must be one of the supported data types in this list or one of the other AIDL-generated interfaces or parcelables you’ve declared. A <code>List</code> may optionally be used as a “generic” class (for example, <code>List&lt;String&gt;</code>). The actual concrete class that the other side receives is always an <code>ArrayList</code>, although the method is generated to use the <code>List</code> interface.</p>
</li>
<li><p><code>Map</code></p>
<p>All elements in the <code>Map</code> must be one of the supported data types in this list or one of the other AIDL-generated interfaces or parcelables you’ve declared. Generic maps, (such as those of the form <code>Map&lt;String,Integer&gt;</code> are not supported. The actual concrete class that the other side receives is always a <code>HashMap</code>, although the method is generated to use the <code>Map</code> interface.</p>
</li>
</ul>
<blockquote>
<p>You must include an <code>import</code> statement for each additional type not listed above, even if they are defined in the same package as your interface.  </p>
</blockquote>
<blockquote>
<p>All non-primitive parameters require a <strong>directional</strong> tag indicating which way the data goes. Either <code>in</code>, <code>out</code>, or <code>inout</code>. Primitives are <code>in</code> by default, and cannot be otherwise.</p>
<p>已验证：这个设定是为了节省传递数据的消耗。<code>in</code> 表示其修饰的参数仅用于提供数据给服务端，因此服务端对该参数的修改，不会影响客户端的实例。<code>out</code>则相反，表示其修饰的参数仅用于从服务端获取数据，接口实现中对该参数的修改将被传递给客户端。</p>
<p>从根据aidl文件生成的java类中，也可以一见端倪。<code>Proxy</code>是客户端用于与<strong>远程</strong>接口交互的代理类，其持有的<code>BinderProxy</code>对象实现了<code>IBinder</code>接口，封装了与Binder驱动的交互细节。<code>Stub</code>是服务端的抽象类，继承了<code>Binder</code>，封装了远程连接的数据读写等操作，也声明了对aidl接口的实现，服务端的接口实现类继承<code>Stub</code>并<strong>实现</strong>aidl接口中声明的方法。对于<code>in</code>、<code>out</code>、<code>inout</code>修饰的参数，有如下特点：</p>
<p>|       | <code>Proxy</code>在调用远程方法前 | <code>Proxy</code>在调用远程方法后 | <code>Stub</code>在调用aidl接口方法前               | <code>Stub</code>在调用aidl接口方法后 |<br>| :—- | :———————- | :———————- | :————————————— | :————————- |<br>| in    | 写入数据                | 不读取数据              | 读取数据                                 | 不写入数据                 |<br>| out   | 忽略参数                | 读取数据                | 直接生成指定类型的对象，并传递给实现方法 | 写入数据                   |<br>| inout | 写入数据                | 读取数据                | 读取数据                                 | 写入数据                   |</p>
</blockquote>
<blockquote>
<p>Objects are reference <strong>counted</strong> across processes.</p>
</blockquote>
<blockquote>
<p>No exceptions that you throw are sent back to the caller.</p>
<p>验证：实际上服务端抛出的部分<code>RuntimeException</code>，是会传递给客户端的。以下描述仅对<strong><em>不</em></strong>被<code>oneway</code>修饰的接口有效。</p>
<p>首先，由于服务端提供的<code>Binder</code>是根据aidl文件生成的，在生成的接口的方法签名中，只抛出了<code>RemoteException</code>，这意味着<code>Binder</code>的实现类中的方法，无法抛出其他<strong>非运行时</strong>的异常。</p>
<p>对于抛出的<strong>运行时异常</strong>，从<code>Binder.execTransact()</code>和<code>Parcel.writeException()</code>可以看出，若是系统“已支持”的异常类型，会将该异常的信息写入数据流中，传递给客户端。而对于其他异常类型，将在<strong><em>服务端</em></strong>抛出<code>RuntimeException</code>。</p>
<p>客户端的远程服务代理类<code>Proxy</code>会在调用<code>Binder.transact()</code>方法后，执行<code>Parcel.readException()</code>，该语句将读取服务端写入数据流中的异常信息，<strong>生成并抛出</strong>对应的异常实例。对于未被传递的异常，客户端读取不到异常。若远程方法因异常终止执行，未将返回值写入数据流（如果该方法有返回值的话），客户端从数据流中也读取不到返回值。</p>
</blockquote>
</li>
<li><p><code>Parcel</code>是传输数据的管道，<code>Parcelable</code>是一个接口，表示其可被<code>Parcel</code>传输。</p>
</li>
</ul>
<h4 id="AIDL类图"><a href="#AIDL类图" class="headerlink" title="AIDL类图"></a>AIDL类图</h4><p><img src="/AIDL Service.png" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/06/29/service/" data-id="cjiztls7i0001wcaq0lgqxx0p" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2018/06/29/dev-note-book/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">dev-note-book</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/06/29/service/">dev-note-book</a>
          </li>
        
          <li>
            <a href="/2018/06/29/dev-note-book/">dev-note-book</a>
          </li>
        
          <li>
            <a href="/2018/06/29/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>